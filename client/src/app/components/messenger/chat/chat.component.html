<div class="chat-container">
  <!-- Панель действий при выборе сообщений -->
  @if (selectionMode && selectedCount > 0) {
    <div class="chat-selection-bar">
      <span class="selection-count">Выбрано: {{ selectedCount }}</span>
      <div class="selection-actions">
        <button type="button" class="selection-btn" (click)="copySelected()" title="Копировать">
          Копировать
        </button>
        <button type="button" class="selection-btn" (click)="forwardSelected()" title="Переслать (скоро)">
          Переслать
        </button>
        <button type="button" class="selection-btn danger" (click)="deleteSelected()" title="Удалить (скоро)">
          Удалить
        </button>
        @if (selectedCount === messages.length) {
          <button type="button" class="selection-btn" (click)="clearSelection()">Снять выбор</button>
        } @else {
          <button type="button" class="selection-btn" (click)="selectAll()">Выбрать все</button>
        }
      </div>
      <button type="button" class="selection-close" (click)="exitSelectionMode()" aria-label="Закрыть">×</button>
    </div>
  }

  <div class="chat-messages" #messagesContainer>
    @for (row of messageRows; track row.type === 'date' ? row.date : row.message.id) {
      @if (row.type === 'date') {
        <div class="date-separator">
          <span class="date-separator-label">{{ row.label }}</span>
        </div>
      }
      @if (row.type === 'message') {
        @let msg = row.message;
        <div
          class="message-wrapper"
          [class.sent]="isSent(msg)"
          [class.received]="!isSent(msg)"
          [class.selected]="selectionMode && isSelected(msg.id)"
          (click)="selectionMode ? toggleMessageSelection(msg.id) : null">
          @if (selectionMode) {
            <div class="message-checkbox" (click)="toggleMessageSelection(msg.id); $event.stopPropagation()">
              <span class="check" [class.checked]="isSelected(msg.id)">{{ isSelected(msg.id) ? '✓' : '' }}</span>
            </div>
          }
          <div class="message-bubble">
            @if (!isSent(msg)) {
              <div class="message-sender">{{ getSenderName(msg) }}</div>
            }
            @if (msg.isForwarded) {
              <div class="message-forwarded-label">Переслано</div>
            }
            @if (msg.replyTo) {
              <div class="message-reply-preview">
                <span class="reply-sender">{{ getSenderName(msg.replyTo) }}</span>
                <span class="reply-text">{{ msg.replyTo.text }}</span>
              </div>
            }
            <div class="message-content">{{ msg.text }}</div>
            <div class="message-meta">
              <span class="message-time">{{ msg.sentAt | date:'HH:mm' }}</span>
              @if (isSent(msg) && msg.status) {
                <span class="message-status" [class]="msg.status" [attr.title]="msg.status"></span>
              }
            </div>
          </div>
        </div>
      }
    }
  </div>

  <div class="chat-input-container">
    <div class="chat-input-wrapper">
      @if (messages.length > 0) {
        <button
          type="button"
          class="chat-mode-btn"
          [class.active]="selectionMode"
          (click)="toggleSelectionMode()"
          title="Режим выбора сообщений">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <path d="M9 12l2 2 4-4"/>
          </svg>
        </button>
      }
      <input
        type="text"
        class="chat-input"
        placeholder="Сообщение"
        [formControl]="newMessage"
        (keydown.enter)="sendMessage()"/>
      <button
        type="button"
        class="send-btn"
        [disabled]="!newMessage.value?.trim() || !isConnected"
        (click)="sendMessage()"
        aria-label="Отправить">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"/>
          <polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      </button>
    </div>
  </div>
</div>
